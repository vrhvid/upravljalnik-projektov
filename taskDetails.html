<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
        <form onsubmit="event.preventDefault(); updateTask();">
            <label for="isCompleted">Stanje:</label><br>
            <select id="isCompleted">
                <option id="notCompleted" value="1">Neopravljen</option>
                <option id="completed" value="2">Opravljena</option>
            </select><br><br>
            <label for="name">Naslov:</label><br>
            <input id="name" type="text" size="55" maxlength="50"><br><br>
            <label for="description">Opis:</label><br>
            <input id="description" type="text" size="505" maxlength="500"><br><br>
            <label for="status">Status:</label><br>
            <p id="status"></p>
            <label for="priority">Prioriteta:</label><br>
            <p id="priority"></p>
            <label for="extResources">Zunanji viri</label><br>
            <input id="extResources" type="text"><br><br>
            <label for="intResources">Lastni viri</label><br>
            <input id="intResources" type="text"><br><br>
            <input type="submit" value="Posodobi nalogo">
        </form>
        <button><a href="tasks.html">Nazaj</a></button>
    </body>
    <script>
        var taskId = window.localStorage.getItem("taskId")
        window.onload = function(){
            var xhr= new XMLHttpRequest();
                
            var url = new URL("http://localhost/upravljalnik-projektov/tasks.php"); 
            url.searchParams.set("action", 2);

            xhr.open("POST", url, true); 
            xhr.setRequestHeader("Accept", "application/json");
            xhr.setRequestHeader('Content-type', 'application/json');
                    
            xhr.onreadystatechange = function (){
                if (xhr.readyState === 4){
                    if(xhr.status === 200){
                        console.log(xhr.responseText)
                        var response = JSON.parse(xhr.responseText);

                        document.getElementById("name").value = response["name"]
                        document.getElementById("description").value = response["description"]
                        document.getElementById("status").innerHTML = response["status"]
                        document.getElementById("priority").innerHTML = response["priority"]
                        document.getElementById("extResources").value = response["externalresources"]
                        document.getElementById("intResources").value = response["internalResources"]
                        if(response["completed"]){
                            document.getElementById("completed").setAttribute("selected", "selected");
                        } else if (!response["completed"]){
                            document.getElementById("notCompleted").setAttribute("selected", "selected");
                        }
                    }
                }
            }
            xhr.send(JSON.stringify({"taskId":taskId}));
        }

        function updateTask(){
            var name = document.getElementById("name").value
            var description = document.getElementById("description").value
            var extResources = document.getElementById("extResources").value
            var intResources = document.getElementById("intResources").value
            if(document.getElementById("isCompleted").value == 1){
                var completed = false
            } else {
                var completed = true
            }

            var xhr= new XMLHttpRequest();

            var url = new URL("http://localhost/upravljalnik-projektov/tasks.php"); 

            xhr.open("PUT", url, true); 
            xhr.setRequestHeader("Accept", "application/json");
			xhr.setRequestHeader('Content-type', 'application/json');
				
			xhr.onreadystatechange = function (){
			    if (xhr.readyState === 4){
					if(xhr.status === 200){
                        location.reload();
                    }
                }
            }
            param = JSON.stringify({"id":taskId, "name":name, "description":description, "extResources":extResources, "intResources":intResources, "completed": completed})
            console.log(param)
            xhr.send(param)
        }
    </script>
</html>